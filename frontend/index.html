<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizMaster - Online Quiz Website</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; } /* slate-50 */
        .main-container { max-width: 1024px; }
        .btn-primary { background-color: #3b82f6; transition: background-color 0.3s ease; } /* blue-500 */
        .btn-primary:hover { background-color: #2563eb; } /* blue-600 */
        .btn-secondary { background-color: #e2e8f0; transition: background-color 0.3s ease; } /* slate-200 */
        .btn-secondary:hover { background-color: #cbd5e1; } /* slate-300 */
        
        .level-card { background-color: #ffffff; border: 1px solid #e2e8f0; }
        .level-card.locked { filter: grayscale(90%); cursor: not-allowed; background-color: #f1f5f9; }
        .level-card.locked .start-quiz-btn { pointer-events: none; background-color: #94a3b8; } /* slate-400 */
        .start-quiz-btn:disabled { background-color: #22c55e; cursor: not-allowed; opacity: 0.7; } /* green-500 */
        
        .option { background-color: #f1f5f9; color: #334155; }
        .option.selected { background-color: #3b82f6; border-color: #60a5fa; color: white; }
    </style>
</head>
<body class="text-slate-800 min-h-screen">
    <div class="main-container mx-auto p-4 md:p-8">

        <header class="flex justify-between items-center mb-12">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                    <i class="fas fa-brain text-white text-xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800">QuizMaster</h1>
            </div>
            <div class="flex items-center space-x-6">
                <nav id="main-nav" class="hidden md:flex items-center space-x-1">
                    <button id="nav-home-btn" class="flex items-center space-x-2 text-slate-600 font-medium hover:bg-slate-200 px-3 py-2 rounded-lg transition"><i class="fas fa-home w-4 text-center"></i><span>Home</span></button>
                    <button id="nav-leaderboard-btn" class="flex items-center space-x-2 text-slate-600 font-medium hover:bg-slate-200 px-3 py-2 rounded-lg transition"><i class="fas fa-trophy w-4 text-center"></i><span>Leaderboard</span></button>
                    <button id="nav-events-btn" class="flex items-center space-x-2 text-slate-600 font-medium hover:bg-slate-200 px-3 py-2 rounded-lg transition"><i class="fas fa-calendar-alt w-4 text-center"></i><span>Events</span></button>
                    <button id="nav-profile-btn" class="flex items-center space-x-2 text-slate-600 font-medium hover:bg-slate-200 px-3 py-2 rounded-lg transition"><i class="fas fa-user w-4 text-center"></i><span>Profile</span></button>
                    <button id="nav-about-btn" class="flex items-center space-x-2 text-slate-600 font-medium hover:bg-slate-200 px-3 py-2 rounded-lg transition"><i class="fas fa-info-circle w-4 text-center"></i><span>About</span></button>
                    <button id="nav-contact-btn" class="flex items-center space-x-2 text-slate-600 font-medium hover:bg-slate-200 px-3 py-2 rounded-lg transition"><i class="fas fa-envelope w-4 text-center"></i><span>Contact</span></button>
                </nav>
                <div id="user-info" class="hidden items-center space-x-4">
                    <span id="username-display" class="font-medium text-lg text-slate-700 hidden lg:block"></span>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center space-x-2 transition-transform transform hover:scale-105"><i class="fas fa-sign-out-alt"></i><span>Logout</span></button>
                </div>
            </div>
        </header>

        <main>
            <div id="login-view" class="hidden">
                <div class="max-w-md mx-auto bg-white rounded-xl p-8 shadow-lg">
                    <h2 class="text-3xl font-bold text-center text-slate-800 mb-6">Login</h2>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="login-username" class="block mb-2 text-sm font-medium text-slate-600">Username</label>
                            <input type="text" id="login-username" class="bg-slate-100 border border-slate-300 text-slate-900 text-sm rounded-lg w-full p-2.5" required>
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block mb-2 text-sm font-medium text-slate-600">Password</label>
                            <input type="password" id="login-password" class="bg-slate-100 border border-slate-300 text-slate-900 text-sm rounded-lg w-full p-2.5" required>
                        </div>
                        <div class="flex items-center justify-between">
                            <button type="submit" class="w-full btn-primary text-white px-5 py-2.5 rounded-lg font-medium">Login</button>
                            <button type="button" id="back-from-login" class="ml-4 btn-secondary text-slate-800 px-5 py-2.5 rounded-lg font-medium">Back</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="signup-view" class="hidden">
                <div class="max-w-md mx-auto bg-white rounded-xl p-8 shadow-lg">
                    <h2 class="text-3xl font-bold text-center text-slate-800 mb-6">Sign Up</h2>
                    <form id="signup-form">
                        <div class="mb-4">
                            <label for="signup-username" class="block mb-2 text-sm font-medium">Username</label>
                            <input type="text" id="signup-username" class="bg-slate-100 border border-slate-300 text-slate-900 text-sm rounded-lg w-full p-2.5" required>
                        </div>
                        <div class="mb-4">
                            <label for="signup-email" class="block mb-2 text-sm font-medium">Email</label>
                            <input type="email" id="signup-email" class="bg-slate-100 border border-slate-300 text-slate-900 text-sm rounded-lg w-full p-2.5" required>
                        </div>
                        <div class="mb-6">
                            <label for="signup-password" class="block mb-2 text-sm font-medium">Password</label>
                            <input type="password" id="signup-password" class="bg-slate-100 border border-slate-300 text-slate-900 text-sm rounded-lg w-full p-2.5" required>
                        </div>
                        <div class="flex items-center justify-between">
                            <button type="submit" class="w-full btn-primary text-white px-5 py-2.5 rounded-lg font-medium">Create Account</button>
                            <button type="button" id="back-from-signup" class="ml-4 btn-secondary text-slate-800 px-5 py-2.5 rounded-lg font-medium">Back</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="dashboard-view">
                <div class="text-center max-w-2xl mx-auto">
                    <h2 class="text-4xl md:text-6xl font-bold text-slate-800 mb-4">Challenge Your Knowledge</h2>
                    <p class="text-lg text-slate-500 mb-8">Take a quiz today!</p>
                    <button id="start-quiz-main-btn" class="btn-primary text-white font-bold py-4 px-12 rounded-full text-lg transition-transform transform hover:scale-105">Start Quiz</button>
                    
                    <div id="dashboard-auth-links" class="mt-6 flex items-center justify-center space-x-4">
                        <button id="dashboard-login-btn" class="btn-secondary text-slate-800 font-semibold py-2 px-6 rounded-full flex items-center space-x-2 transition-transform transform hover:scale-105"><i class="fas fa-sign-in-alt"></i><span>Login</span></button>
                        <button id="dashboard-signup-btn" class="btn-primary text-white font-semibold py-2 px-6 rounded-full flex items-center space-x-2 transition-transform transform hover:scale-105"><i class="fas fa-user-plus"></i><span>Sign Up</span></button>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mt-16 max-w-4xl mx-auto">
                    <div class="category-card bg-white rounded-2xl shadow-md p-6 text-center cursor-pointer hover:shadow-xl hover:-translate-y-2 transition-all">
                        <div class="bg-yellow-100 rounded-xl w-20 h-20 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-lightbulb text-4xl text-yellow-500"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800">General Knowledge</h3>
                    </div>
                    <div class="category-card bg-white rounded-2xl shadow-md p-6 text-center cursor-pointer hover:shadow-xl hover:-translate-y-2 transition-all">
                        <div class="bg-blue-100 rounded-xl w-20 h-20 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-flask text-4xl text-blue-500"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800">Science</h3>
                    </div>
                    <div class="category-card bg-white rounded-2xl shadow-md p-6 text-center cursor-pointer hover:shadow-xl hover:-translate-y-2 transition-all">
                        <div class="bg-orange-100 rounded-xl w-20 h-20 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-landmark text-4xl text-orange-500"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800">History</h3>
                    </div>
                    <div class="category-card bg-white rounded-2xl shadow-md p-6 text-center cursor-pointer hover:shadow-xl hover:-translate-y-2 transition-all">
                        <div class="bg-green-100 rounded-xl w-20 h-20 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-futbol text-4xl text-green-500"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800">Sports</h3>
                    </div>
                </div>
            </div>

            <div id="level-selection-view" class="hidden">
                <h2 class="text-4xl font-bold text-center text-slate-800 mb-8">Select Your Challenge</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div id="level-Easy" class="level-card rounded-xl p-6 text-center hover:shadow-lg transition"><i class="fas fa-seedling text-6xl text-green-500 mb-4"></i><h3 class="text-2xl font-bold text-slate-800 mb-2">Easy</h3><p class="text-slate-500 mb-4">5 questions to warm you up.</p><button data-level="Easy" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-medium start-quiz-btn">Play</button></div>
                    <div id="level-Medium" class="level-card rounded-xl p-6 text-center hover:shadow-lg transition"><div class="relative"><i class="fas fa-mountain text-6xl text-yellow-500 mb-4"></i><div class="lock-icon absolute top-0 right-0 -mt-2 -mr-2 hidden"><i class="fas fa-lock text-2xl text-slate-400"></i></div></div><h3 class="text-2xl font-bold text-slate-800 mb-2">Medium</h3><p class="text-slate-500 mb-4">5 challenging questions await.</p><button data-level="Medium" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-3 rounded-lg font-medium start-quiz-btn">Play</button></div>
                    <div id="level-Hard" class="level-card rounded-xl p-6 text-center hover:shadow-lg transition"><div class="relative"><i class="fas fa-fire text-6xl text-red-500 mb-4"></i><div class="lock-icon absolute top-0 right-0 -mt-2 -mr-2 hidden"><i class="fas fa-lock text-2xl text-slate-400"></i></div></div><h3 class="text-2xl font-bold text-slate-800 mb-2">Hard</h3><p class="text-slate-500 mb-4">5 expert-level questions.</p><button data-level="Hard" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-medium start-quiz-btn">Play</button></div>
                </div>
                <div class="text-center mt-12"><button id="back-to-dash-from-levels" class="btn-secondary text-slate-800 px-8 py-3 rounded-lg font-medium">Back to Dashboard</button></div>
            </div>

            <div id="quiz-view" class="hidden">
                <div class="max-w-3xl mx-auto bg-white rounded-xl p-8 shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="quiz-level-title" class="text-2xl font-bold text-slate-800"></h2>
                        <div class="flex items-center space-x-4">
                            <div class="text-lg font-medium text-slate-600">Question <span id="current-q-num">1</span> of 5</div>
                            <div id="timer-container" class="text-lg font-mono font-bold text-slate-800 bg-slate-100 px-3 py-1 rounded-lg"><i class="fas fa-clock mr-2 text-slate-500"></i><span id="timer">00:30</span></div>
                        </div>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2.5 mb-6"><div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 20%"></div></div>
                    <p id="question-text" class="text-2xl font-semibold text-slate-800 mb-8 text-center min-h-[6rem]"></p>
                    <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8"></div>
                    <div class="flex justify-between items-center">
                        <button id="prev-btn" class="btn-secondary text-slate-800 px-8 py-3 rounded-lg font-medium">Previous</button>
                        <button id="next-btn" class="btn-primary text-white px-8 py-3 rounded-lg font-medium">Next</button>
                    </div>
                </div>
            </div>
            
            <div id="results-view" class="hidden">
                <div class="max-w-2xl mx-auto bg-white rounded-xl p-8 text-center shadow-lg">
                    <i id="results-icon" class="fas text-7xl mb-4"></i>
                    <h2 id="results-title" class="text-4xl font-bold text-slate-800 mb-2">Level Complete!</h2>
                    <p id="results-level-text" class="text-slate-500 mb-6"></p>
                    <div class="bg-slate-50 rounded-lg p-6 mb-8">
                        <p class="text-slate-600 text-lg">Your Score</p>
                        <p id="results-score" class="text-6xl font-bold text-slate-800 my-2"></p>
                        <p id="results-remark" class="text-2xl font-semibold"></p>
                    </div>
                    <div class="flex justify-center space-x-4">
                        <button id="next-level-btn" class="btn-primary text-white px-6 py-3 rounded-lg font-medium">Continue</button>
                        <button id="view-answers-btn" class="btn-secondary text-slate-800 px-6 py-3 rounded-lg font-medium">View Answers</button>
                        <button id="back-to-levels-btn" class="bg-slate-600 hover:bg-slate-700 text-white px-6 py-3 rounded-lg font-medium">Change Level</button>
                    </div>
                </div>
            </div>

            <div id="summary-view" class="hidden">
                <div class="max-w-3xl mx-auto bg-white rounded-xl p-8 text-center shadow-lg">
                    <i class="fas fa-award text-7xl text-yellow-400 mb-4"></i>
                    <h2 class="text-4xl font-bold text-slate-800 mb-2">Quiz Challenge Complete!</h2>
                    <p class="text-slate-500 mb-8">Congratulations! Here is your final performance summary.</p>
                    
                    <div id="summary-levels-container" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"></div>

                    <div class="bg-slate-50 rounded-lg p-6 mb-8">
                        <p class="text-slate-600 text-lg">Overall Performance</p>
                        <p id="summary-total-score" class="text-6xl font-bold text-slate-800 my-2"></p>
                        <p id="summary-overall-remark" class="text-2xl font-semibold"></p>
                    </div>
                    <div class="flex justify-center space-x-4">
                        <button id="summary-play-again-btn" class="btn-primary text-white px-6 py-3 rounded-lg font-medium">Play Again</button>
                        <button id="summary-leaderboard-btn" class="btn-secondary text-slate-800 px-6 py-3 rounded-lg font-medium">View Leaderboard</button>
                    </div>
                </div>
            </div>

            <div id="page-view" class="hidden">
                <div class="max-w-4xl mx-auto bg-white rounded-xl p-8 shadow-lg">
                    <h2 id="page-title" class="text-4xl font-bold text-slate-800 mb-6"></h2>
                    <div id="page-content" class="prose max-w-none text-slate-600"></div>
                    <div id="page-actions" class="text-center mt-10">
                        <button id="back-to-dash-from-page" class="btn-secondary text-slate-800 px-8 py-3 rounded-lg font-medium">Back to Dashboard</button>
                    </div>
                </div>
            </div>

        </main>
        
        <footer class="text-slate-500 mt-16 pt-8 border-t border-slate-200 flex flex-col items-center">
            <div class="flex space-x-4 mb-4">
                <a href="#" class="w-10 h-10 rounded-full bg-slate-200 hover:bg-slate-300 flex items-center justify-center transition">
                    <i class="fab fa-facebook-f text-slate-600"></i>
                </a>
                <a href="#" class="w-10 h-10 rounded-full bg-slate-200 hover:bg-slate-300 flex items-center justify-center transition">
                    <i class="fab fa-twitter text-slate-600"></i>
                </a>
                <a href="#" class="w-10 h-10 rounded-full bg-slate-200 hover:bg-slate-300 flex items-center justify-center transition">
                    <i class="fab fa-snapchat-ghost text-slate-600"></i>
                </a>
                <a href="#" class="w-10 h-10 rounded-full bg-slate-200 hover:bg-slate-300 flex items-center justify-center transition">
                    <i class="fab fa-instagram text-slate-600"></i>
                </a>
            </div>
            <p>&copy; 2025 QuizMaster. All rights reserved.</p>
        </footer>
    </div>

    <div id="chatbot-container" class="fixed bottom-5 right-5 z-50">
        <div id="chatbot-icon" class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center cursor-pointer shadow-lg hover:bg-blue-700 transition"><i class="fas fa-comment-dots text-white text-3xl"></i></div>
        <div id="chatbot-window" class="hidden absolute bottom-20 right-0 w-80 bg-white rounded-xl shadow-2xl border border-slate-200">
            <div class="p-4 border-b border-slate-200"><h3 class="font-bold text-lg text-slate-800">QuizBot Assistant</h3></div>
            <div id="chatbot-messages" class="p-4 h-64 overflow-y-auto"></div>
            <div class="p-4 border-t border-slate-200"><input type="text" id="chatbot-input" class="bg-slate-100 border border-slate-300 text-slate-900 w-full rounded-lg p-2" placeholder="Type your response..."></div>
        </div>
    </div>
    
    <div id="modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-sm w-full text-center border border-slate-200 shadow-lg">
            <p id="modal-message" class="text-lg text-slate-700 mb-6" style="white-space: pre-wrap;"></p>
            <button id="modal-close-btn" class="btn-primary text-white px-6 py-2 rounded-lg">OK</button>
        </div>
    </div>
    
    <div id="startup-error-overlay" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-[100] text-white p-8">
        <div class="text-center max-w-2xl">
            <i class="fas fa-exclamation-triangle text-5xl text-yellow-400 mb-6"></i>
            <h2 class="text-3xl font-bold mb-4">Application Cannot Start</h2>
            <p class="text-lg text-slate-300 mb-6">
                This page must be opened using a local web server, not directly as a file. Opening it from your computer's folder will cause connection errors.
            </p>
            <div class="bg-slate-800 p-6 rounded-lg text-left">
                <h3 class="font-bold text-xl mb-3">How to Fix This:</h3>
                <ol class="list-decimal list-inside space-y-2">
                    <li>Make sure your backend server is running (<code class="bg-slate-900 px-2 py-1 rounded">npm start</code> in the backend folder).</li>
                    <li>In your code editor (like VS Code), right-click on the <code class="bg-slate-900 px-2 py-1 rounded">index.html</code> file.</li>
                    <li>Select the option: <strong class="text-green-400">"Open with Live Server"</strong>.</li>
                </ol>
                <p class="mt-4 text-slate-400 text-sm">This will open a new browser tab with the correct address (starting with http://) and allow the application to work correctly.</p>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG ---
        const API_URL = 'http://localhost:3000/api';

        // --- DOM Elements ---
        const views = { login: document.getElementById('login-view'), signup: document.getElementById('signup-view'), dashboard: document.getElementById('dashboard-view'), levelSelection: document.getElementById('level-selection-view'), quiz: document.getElementById('quiz-view'), results: document.getElementById('results-view'), summary: document.getElementById('summary-view'), page: document.getElementById('page-view'), };
        const mainNav = document.getElementById('main-nav');
        const userInfo = document.getElementById('user-info');
        const usernameDisplay = document.getElementById('username-display');
        const dashboardAuthLinks = document.getElementById('dashboard-auth-links');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        const chatbotIcon = document.getElementById('chatbot-icon');
        const chatbotWindow = document.getElementById('chatbot-window');
        const chatbotMessages = document.getElementById('chatbot-messages');
        const chatbotInput = document.getElementById('chatbot-input');

        // --- State ---
        let appState = {
            token: localStorage.getItem('quizToken'),
            username: localStorage.getItem('quizUsername'),
            completedLevels: [],
            currentQuiz: { level: null, questions: [], answers: {}, correctAnswers: {}, currentIndex: 0, timerId: null, timeLeft: 0, },
            chatbot: { state: 'idle', feedback: '' }
        };

        // --- Main App Logic ---
        function navigateTo(viewName) { Object.values(views).forEach(v => v.classList.add('hidden')); if(views[viewName]) views[viewName].classList.remove('hidden'); }
        function showModal(message) { modalMessage.textContent = message; modal.classList.remove('hidden'); }

        async function fetchWithAuth(url, options = {}) {
            const headers = { ...options.headers, 'Content-Type': 'application/json' };
            if (appState.token) { headers['Authorization'] = `Bearer ${appState.token}`; }
            try {
                const response = await fetch(url, { ...options, headers });
                if (response.status === 401 || response.status === 403) {
                    logout();
                    showModal("Your session is invalid or has expired. Please log in again.");
                    throw new Error("Auth error");
                }
                return response;
            } catch (error) {
                if (error.message !== "Auth error") {
                    const detailedMessage = `Connection Error!\n\nPlease follow these steps:\n\n1. Make sure your backend server is running in the terminal.\n\n2. Make sure you have opened this HTML file using the "Open with Live Server" extension in your code editor.\n\n(The browser is blocking the connection for security reasons if you open this file directly.)`;
                    showModal(detailedMessage);
                }
                throw error;
            }
        }
        
        async function initializeUserSession() {
            dashboardAuthLinks.classList.add('hidden');
            mainNav.classList.remove('hidden');
            userInfo.classList.remove('hidden');
            usernameDisplay.textContent = `${appState.username}`;
            await fetchUserResults();
            navigateTo('dashboard');
            startChatbotConversation('login');
        }

        function updateUIForAuthState() {
            if (appState.token) {
                initializeUserSession();
            } else {
                dashboardAuthLinks.classList.remove('hidden');
                mainNav.classList.add('hidden');
                userInfo.classList.add('hidden');
                navigateTo('dashboard');
                startChatbotConversation('logout');
            }
        }

        async function handleAuth(endpoint, body) {
            try {
                const res = await fetch(`${API_URL}/${endpoint}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message);
                if (data.token) {
                    appState.token = data.token; appState.username = data.username;
                    localStorage.setItem('quizToken', data.token); localStorage.setItem('quizUsername', data.username);
                    updateUIForAuthState();
                } else { showModal('Registration successful! Please log in.'); navigateTo('login'); }
            } catch (err) { showModal(err.message); }
        }

        function logout() {
            clearInterval(appState.currentQuiz.timerId);
            appState.token = null; appState.username = null; appState.completedLevels = [];
            localStorage.removeItem('quizToken'); localStorage.removeItem('quizUsername');
            updateUIForAuthState();
        }

        async function fetchUserResults() {
            if (!appState.token) return;
            try {
                const res = await fetchWithAuth(`${API_URL}/results`);
                if (!res.ok) throw new Error('Could not fetch user results.');
                appState.completedLevels = (await res.json()).map(r => r.level);
            } catch (err) { /* Auth errors are handled by fetchWithAuth */ }
        }

        function showLevelSelection() { if (!appState.token) { showModal("Please log in to start a challenge."); return; } updateLevelStates(); navigateTo('levelSelection'); }
        
        function updateLevelStates() {
            const completed = appState.completedLevels;
            ['Easy', 'Medium', 'Hard'].forEach(level => {
                const card = document.getElementById(`level-${level}`);
                if (!card) return;
                const btn = card.querySelector('.start-quiz-btn');
                
                if(completed.includes(level)) {
                    btn.textContent = '✓ Completed';
                    btn.disabled = true;
                } else {
                    btn.textContent = 'Play';
                    btn.disabled = false;
                }

                let isLocked = false;
                if(level === 'Medium' && !completed.includes('Easy')) isLocked = true;
                if(level === 'Hard' && !completed.includes('Medium')) isLocked = true;

                card.classList.toggle('locked', isLocked);
                const lockIcon = card.querySelector('.lock-icon');
                if (lockIcon) {
                    lockIcon.classList.toggle('hidden', !isLocked);
                }
                if(isLocked) btn.disabled = true;
            });
        }

        function startTimer() {
            clearInterval(appState.currentQuiz.timerId);
            const levelTimes = { 'Easy': 30, 'Medium': 45, 'Hard': 60 };
            appState.currentQuiz.timeLeft = levelTimes[appState.currentQuiz.level] || 30;
            const timerEl = document.getElementById('timer'), timerContainer = document.getElementById('timer-container');
            const updateDisplay = () => {
                timerEl.textContent = `${Math.floor(appState.currentQuiz.timeLeft / 60).toString().padStart(2, '0')}:${(appState.currentQuiz.timeLeft % 60).toString().padStart(2, '0')}`;
                timerContainer.classList.toggle('text-red-500', appState.currentQuiz.timeLeft <= 10);
                timerContainer.classList.toggle('text-slate-800', appState.currentQuiz.timeLeft > 10);
            };
            updateDisplay();
            appState.currentQuiz.timerId = setInterval(() => {
                appState.currentQuiz.timeLeft--; updateDisplay();
                if (appState.currentQuiz.timeLeft <= 0) {
                    clearInterval(appState.currentQuiz.timerId); showModal('Time is up! Submitting automatically.');
                    setTimeout(submitQuiz, 1500);
                }
            }, 1000);
        }

        async function startQuiz(level) {
            try {
                const res = await fetchWithAuth(`${API_URL}/questions/${level}`);
                if (!res.ok) throw new Error(`Could not fetch questions.`);
                appState.currentQuiz = { ...appState.currentQuiz, level, questions: await res.json(), answers: {}, currentIndex: 0, };
                navigateTo('quiz'); renderCurrentQuestion(); startTimer();
            } catch (err) { /* Auth/network errors are handled by fetchWithAuth */ }
        }

        function renderCurrentQuestion() {
            const quiz = appState.currentQuiz; if (!quiz.questions.length) return;
            const question = quiz.questions[quiz.currentIndex];
            document.getElementById('quiz-level-title').textContent = `${quiz.level} Level`;
            document.getElementById('current-q-num').textContent = quiz.currentIndex + 1;
            document.getElementById('progress-bar').style.width = `${((quiz.currentIndex + 1) / quiz.questions.length) * 100}%`;
            document.getElementById('question-text').textContent = question.question;
            const optsContainer = document.getElementById('options-container'); optsContainer.innerHTML = '';
            ['A', 'B', 'C', 'D'].forEach(opt => {
                const optionText = question[`option${opt}`];
                const btn = document.createElement('button');
                btn.className = 'option p-4 rounded-lg text-left hover:bg-slate-200 transition border-2 border-transparent';
                btn.textContent = optionText;
                if (quiz.answers[question.id] === optionText) btn.classList.add('selected');
                btn.onclick = () => { quiz.answers[question.id] = optionText; renderCurrentQuestion(); };
                optsContainer.appendChild(btn);
            });
            const prevBtn = document.getElementById('prev-btn'), nextBtn = document.getElementById('next-btn');
            prevBtn.disabled = quiz.currentIndex === 0; prevBtn.classList.toggle('opacity-50', quiz.currentIndex === 0);
            nextBtn.textContent = (quiz.currentIndex === quiz.questions.length - 1) ? 'Submit' : 'Next';
        }

        function navigateQuestion(dir) {
            const quiz = appState.currentQuiz; const newIdx = quiz.currentIndex + dir;
            if (newIdx >= 0 && newIdx < quiz.questions.length) { quiz.currentIndex = newIdx; renderCurrentQuestion(); }
        }
        
        async function submitQuiz() {
            clearInterval(appState.currentQuiz.timerId); if(views.quiz.classList.contains('hidden')) return;
            try {
                const res = await fetchWithAuth(`${API_URL}/submit`, { method: 'POST', body: JSON.stringify({ level: appState.currentQuiz.level, userAnswers: appState.currentQuiz.answers }) });
                const resultData = await res.json(); 
                if (!res.ok) throw new Error(resultData.message);
                if (!appState.completedLevels.includes(appState.currentQuiz.level)) appState.completedLevels.push(appState.currentQuiz.level);
                appState.currentQuiz.correctAnswers = resultData.correctAnswers;
                showResults(resultData);
            } catch (err) { if (err.message !== "Auth error") showModal(err.message || "An unknown error occurred while submitting."); }
        }
        
        function showResults(data) {
            document.getElementById('results-level-text').textContent = `You've completed the ${appState.currentQuiz.level} level.`;
            document.getElementById('results-score').textContent = `${data.score} / ${data.total}`;
            document.getElementById('results-remark').textContent = data.remarks;
            const remarkEl = document.getElementById('results-remark'), iconEl = document.getElementById('results-icon');
            remarkEl.className = 'text-2xl font-semibold'; iconEl.className = 'fas text-7xl mb-4';
            if (data.score / data.total >= 0.8) { remarkEl.classList.add('text-green-500'); iconEl.classList.add('fa-check-circle', 'text-green-500'); }
            else if (data.score / data.total >= 0.6) { remarkEl.classList.add('text-yellow-500'); iconEl.classList.add('fa-thumbs-up', 'text-yellow-500'); }
            else { remarkEl.classList.add('text-red-500'); iconEl.classList.add('fa-times-circle', 'text-red-500'); }
            const nextBtn = document.getElementById('next-level-btn'), lvl = appState.currentQuiz.level;
            
            if (lvl === 'Hard') {
                nextBtn.textContent = 'View Final Summary';
                nextBtn.onclick = showSummary;
            } else if (lvl === 'Easy') {
                nextBtn.textContent = 'Start Medium Level';
                nextBtn.onclick = () => startQuiz('Medium');
            } else if (lvl === 'Medium') {
                nextBtn.textContent = 'Start Hard Level';
                nextBtn.onclick = () => startQuiz('Hard');
            }
            navigateTo('results');
            startChatbotConversation('results');
        }

        async function showSummary() {
            try {
                const res = await fetchWithAuth(`${API_URL}/summary`);
                if(!res.ok) throw new Error('Could not load summary data.');
                const summaryData = await res.json();
                
                const container = document.getElementById('summary-levels-container');
                container.innerHTML = '';
                let totalScore = 0;
                let totalQuestions = 0;

                const levelColors = { Easy: 'green-500', Medium: 'yellow-500', Hard: 'red-500' };

                summaryData.forEach(levelResult => {
                    const score = levelResult.best_score;
                    const total = levelResult.total_questions;
                    totalScore += score;
                    totalQuestions += total;
                    const remark = score / total >= 0.8 ? "Excellent" : (score / total >= 0.6 ? "Good" : "Needs Improvement");
                    const color = levelColors[levelResult.level];

                    container.innerHTML += `
                        <div class="bg-slate-100 rounded-lg p-4">
                            <h3 class="font-bold text-xl text-slate-800 mb-2">${levelResult.level} Level</h3>
                            <p class="text-3xl font-bold text-slate-900">${score} / ${total}</p>
                            <p class="text-${color}">${remark}</p>
                        </div>
                    `;
                });

                document.getElementById('summary-total-score').textContent = `${totalScore} / ${totalQuestions}`;
                const overallPercentage = totalQuestions > 0 ? totalScore / totalQuestions : 0;
                const overallRemarkEl = document.getElementById('summary-overall-remark');
                if (overallPercentage >= 0.8) {
                    overallRemarkEl.textContent = "Quiz Master!";
                    overallRemarkEl.className = 'text-2xl font-semibold text-green-500';
                } else if (overallPercentage >= 0.6) {
                    overallRemarkEl.textContent = "Great Job!";
                    overallRemarkEl.className = 'text-2xl font-semibold text-yellow-500';
                } else {
                    overallRemarkEl.textContent = "Good Effort!";
                    overallRemarkEl.className = 'text-2xl font-semibold text-red-500';
                }

                navigateTo('summary');
            } catch(err) {
                if (err.message !== "Auth error") showModal(err.message);
            }
        }

        async function showPage(type) {
            let title = '', content = '';
            const pageActions = document.getElementById('page-actions');
            pageActions.innerHTML = '<button id="back-to-dash-from-page" class="btn-secondary text-slate-800 px-8 py-3 rounded-lg font-medium">Back to Dashboard</button>';
            document.getElementById('back-to-dash-from-page').onclick = () => navigateTo('dashboard');

            if (type === 'details') { title = 'Quiz Details'; content = `<p>Welcome to QuizMaster!</p><ul class="list-disc list-inside space-y-2 my-4"><li><strong>Easy:</strong> 5 questions, 30-second timer.</li><li><strong>Medium:</strong> 5 questions, 45-second timer.</li><li><strong>Hard:</strong> 5 questions, 60-second timer.</li></ul><p>Complete levels in sequence to unlock the next challenge and climb the leaderboard!</p>`; }
            else if (type === 'about') { title = 'About QuizMaster'; content = `<p>QuizMaster is a full-stack web application demonstrating modern web technologies to create a fun, engaging, and seamless user experience for quiz takers.</p>`; }
            else if (type === 'contact') { title = 'Contact Us'; content = `<p>If you have any questions, feedback, or inquiries, please feel free to reach out to us at <a href="mailto:support@quizmaster.com" class="text-blue-500 hover:underline">support@quizmaster.com</a>. We'd love to hear from you!</p>`; }
            else if (type === 'privacy') { title = 'Privacy Policy'; content = `<p>Your privacy is important to us. At QuizMaster, we have a few fundamental principles:</p><ul class="list-disc list-inside space-y-2 my-4"><li>We don’t ask you for personal information unless we truly need it.</li><li>We don’t share your personal information with anyone except to comply with the law, develop our products, or protect our rights.</li><li>We don’t store personal information on our servers unless required for the on-going operation of one of our services.</li></ul><p>This policy is based on these principles. If you have questions about deleting or correcting your personal data please contact our support team.</p>`; }
            else if (type === 'leaderboard') { title = 'Leaderboard'; content = `<p>Loading top players...</p>`; try { const res = await fetch(`${API_URL}/leaderboard`); if (!res.ok) throw new Error('Could not fetch leaderboard.'); const data = await res.json(); let html = '<ol class="list-decimal list-inside space-y-3">'; data.forEach((p, i) => { html += `<li class="text-xl p-3 rounded ${i === 0 ? 'bg-yellow-100 text-yellow-800' : i === 1 ? 'bg-slate-200' : i === 2 ? 'bg-orange-100 text-orange-800' : 'bg-slate-50'}"><span class="font-bold mr-2">${i + 1}.</span><span>${p.username}</span><span class="float-right font-bold">${p.total_score} pts</span></li>`; }); html += '</ol>'; content = html; } catch(err) { content = `<p class="text-red-500">${err.message}</p>`; } }
            else if (type === 'profile') { 
                title = 'Your Profile'; 
                content = `<p>Loading profile data...</p>`;
                try {
                    const res = await fetchWithAuth(`${API_URL}/summary`);
                    if(!res.ok) throw new Error('Could not load profile data.');
                    const summaryData = await res.json();
                    let totalScore = 0, totalQuestions = 0;
                    summaryData.forEach(r => { totalScore += r.best_score; totalQuestions += r.total_questions; });
                    const overallPercentage = totalQuestions > 0 ? ((totalScore/totalQuestions) * 100).toFixed(1) : 0;
                    content = `
                        <div class="text-center"><i class="fas fa-user-circle text-8xl text-slate-400 mb-4"></i><h3 class="text-3xl font-bold text-slate-800">${appState.username}</h3></div>
                        <div class="mt-8 bg-slate-50 p-6 rounded-xl">
                            <h4 class="text-2xl font-bold text-slate-700 mb-4">Quiz Statistics</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                                <div class="bg-white p-4 rounded-lg shadow"><p class="text-slate-500 text-sm">Levels Completed</p><p class="text-3xl font-bold text-blue-500">${appState.completedLevels.length} / 3</p></div>
                                <div class="bg-white p-4 rounded-lg shadow"><p class="text-slate-500 text-sm">Total Score</p><p class="text-3xl font-bold text-green-500">${totalScore}</p></div>
                                <div class="bg-white p-4 rounded-lg shadow"><p class="text-slate-500 text-sm">Average Accuracy</p><p class="text-3xl font-bold text-yellow-500">${overallPercentage}%</p></div>
                            </div>
                        </div>
                    `;
                } catch(err) { content = `<p class="text-red-500">Could not load profile statistics.</p>`; }
            }
            else if (type === 'events') { title = 'Upcoming Events'; content = `<p>There are currently no upcoming events. Please check back later for updates on new quizzes and competitions!</p>`; }
            else if (type === 'answers') {
                title = `${appState.currentQuiz.level} Level - Your Answers`;
                let answerHtml = '<div class="space-y-4">';
                appState.currentQuiz.questions.forEach(q => {
                    const userAnswer = appState.currentQuiz.answers[q.id];
                    const correctAnswer = appState.currentQuiz.correctAnswers[q.id];
                    const isCorrect = userAnswer === correctAnswer;
                    answerHtml += `<div class="p-4 rounded-lg ${isCorrect ? 'bg-green-100' : 'bg-red-100'}">
                        <p class="font-bold">${q.question}</p>
                        <p>Your answer: <span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">${userAnswer || "Not answered"}</span></p>
                        ${!isCorrect ? `<p>Correct answer: <span class="text-green-600">${correctAnswer}</span></p>` : ''}
                    </div>`;
                });
                answerHtml += '</div>';
                content = answerHtml;
                pageActions.innerHTML = '<button id="back-to-results-from-page" class="btn-secondary text-slate-800 px-8 py-3 rounded-lg font-medium">Back to Results</button>';
                document.getElementById('back-to-results-from-page').onclick = () => navigateTo('results');
            }
            document.getElementById('page-title').textContent = title; document.getElementById('page-content').innerHTML = content; navigateTo('page');
        }

        // --- Chatbot Logic ---
        function addChatMessage(sender, message) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `mb-2 ${sender === 'bot' ? 'text-left' : 'text-right'}`;
            msgDiv.innerHTML = `<span class="inline-block p-2 rounded-lg ${sender === 'bot' ? 'bg-slate-200 text-slate-800' : 'bg-blue-500 text-white'}">${message}</span>`;
            chatbotMessages.appendChild(msgDiv);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }

        function startChatbotConversation(context) {
            chatbotMessages.innerHTML = '';
            if (context === 'login' && appState.token) {
                appState.chatbot.state = 'awaiting_start';
                chatbotWindow.classList.remove('hidden');
                addChatMessage('bot', `Hi ${appState.username}! Welcome to QuizMaster. Shall we begin the quiz? (yes/no)`);
            } else if (context === 'results') {
                appState.chatbot.state = 'awaiting_feedback';
                chatbotWindow.classList.remove('hidden');
                addChatMessage('bot', 'Great job! How did you find the quiz? (e.g., "It was fun", "Too easy", etc.)');
            } else if (context === 'logout') {
                chatbotWindow.classList.add('hidden');
                appState.chatbot.state = 'idle';
            }
        }

        async function handleChatbotInput() {
            const userInput = chatbotInput.value.trim(); if (!userInput) return;
            addChatMessage('user', userInput);
            const userInputLower = userInput.toLowerCase();
            chatbotInput.value = '';
            const state = appState.chatbot.state;

            if (state === 'awaiting_start') {
                if (userInputLower.includes('yes')) {
                    showLevelSelection();
                    chatbotWindow.classList.add('hidden');
                } else {
                    addChatMessage('bot', 'Thanks for visiting! Logging you out now.');
                    setTimeout(logout, 2000);
                }
                appState.chatbot.state = 'idle';
            } else if (state === 'awaiting_feedback') {
                appState.chatbot.feedback = userInput;
                addChatMessage('bot', 'Thanks for the feedback! Would you like a PDF of your results sent to your email? (yes/no)');
                appState.chatbot.state = 'awaiting_email';
            } else if (state === 'awaiting_email') {
                if (userInputLower.includes('yes')) {
                    addChatMessage('bot', 'Sending your results now...');
                    try {
                        const res = await fetchWithAuth(`${API_URL}/send-email`, { method: 'POST', body: JSON.stringify({ feedback: appState.chatbot.feedback, result: { level: appState.currentQuiz.level, score: document.getElementById('results-score').textContent.split('/')[0].trim(), total: 5 } }) });
                        const data = await res.json(); if (!res.ok) throw new Error(data.message);
                        addChatMessage('bot', 'Email sent successfully!');
                    } catch (err) { /* Auth/network errors are handled by fetchWithAuth */ }
                } else { addChatMessage('bot', 'Okay, no problem!'); }
                setTimeout(() => { addChatMessage('bot', 'Thank you for playing! Would you like to log out now? (yes/no)'); appState.chatbot.state = 'awaiting_logout'; }, 1000);
            } else if (state === 'awaiting_logout') {
                if (userInputLower.includes('yes')) { logout(); }
                else { addChatMessage('bot', 'Alright! Feel free to play another level or explore the site.'); }
                appState.chatbot.state = 'idle';
                setTimeout(() => chatbotWindow.classList.add('hidden'), 2000);
            }
        }

        // --- Event Listeners ---
        document.getElementById('dashboard-login-btn').onclick = () => navigateTo('login');
        document.getElementById('dashboard-signup-btn').onclick = () => navigateTo('signup');
        document.getElementById('back-from-login').onclick = () => navigateTo('dashboard');
        document.getElementById('back-from-signup').onclick = () => navigateTo('dashboard');
        document.getElementById('login-form').onsubmit = (e) => { e.preventDefault(); handleAuth('login', { username: e.target.elements['login-username'].value, password: e.target.elements['login-password'].value }); };
        document.getElementById('signup-form').onsubmit = (e) => { e.preventDefault(); handleAuth('register', { username: e.target.elements['signup-username'].value, email: e.target.elements['signup-email'].value, password: e.target.elements['signup-password'].value }); };
        document.getElementById('logout-btn').onclick = logout;
        document.getElementById('modal-close-btn').onclick = () => modal.classList.add('hidden');
        document.getElementById('nav-home-btn').onclick = () => navigateTo('dashboard');
        document.getElementById('nav-leaderboard-btn').onclick = () => showPage('leaderboard');
        document.getElementById('nav-events-btn').onclick = () => showPage('events');
        document.getElementById('nav-profile-btn').onclick = () => showPage('profile');
        document.getElementById('nav-about-btn').onclick = () => showPage('about');
        document.getElementById('nav-contact-btn').onclick = () => showPage('contact');
        
        document.getElementById('start-quiz-main-btn').onclick = showLevelSelection;
        document.querySelectorAll('.category-card').forEach(c => c.onclick = showLevelSelection);
        document.getElementById('back-to-dash-from-levels').onclick = () => navigateTo('dashboard');
        document.querySelectorAll('.start-quiz-btn').forEach(b => b.onclick = (e) => { if (e.currentTarget.parentElement.classList.contains('locked')) { showModal('Complete the previous level to unlock this.'); return; } startQuiz(e.currentTarget.dataset.level); });
        document.getElementById('prev-btn').onclick = () => navigateQuestion(-1);
        document.getElementById('next-btn').onclick = () => { if(document.getElementById('next-btn').textContent === 'Submit') submitQuiz(); else navigateQuestion(1); };
        document.getElementById('back-to-levels-btn').onclick = showLevelSelection;
        document.getElementById('view-answers-btn').onclick = () => showPage('answers');
        document.getElementById('summary-play-again-btn').onclick = () => { appState.completedLevels = []; showLevelSelection(); };
        document.getElementById('summary-leaderboard-btn').onclick = () => showPage('leaderboard');
        
        chatbotIcon.onclick = () => chatbotWindow.classList.toggle('hidden');
        chatbotInput.onkeydown = (e) => { if (e.key === 'Enter') handleChatbotInput(); };
        
        // --- Initial Load ---
        function checkFileProtocol() {
            if (window.location.protocol === 'file:') {
                document.getElementById('startup-error-overlay').classList.remove('hidden');
                return false;
            }
            return true;
        }

        if (checkFileProtocol()) {
            updateUIForAuthState();
        }
    });
    </script>
</body>
</html>